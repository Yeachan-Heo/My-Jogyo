# Gyoshu Notebook-Centric Architecture Plan

**Goal**: Transform Gyoshu from JSON-metadata-heavy to notebook-first, self-describing architecture

**Research Sources**:
- Quarto: YAML frontmatter in notebook raw cells
- nbdev: Notebooks as source of truth, README.md auto-generation
- Papermill: Cell tags for parameterization and execution tracking
- oh-my-opencode: Hierarchical AGENTS.md, markdown-embedded metadata
- Deep-Research: Session-based organization, multiple report views

---

## Core Design Principles

1. **Notebooks ARE the metadata** - No separate JSON manifest files
2. **README.md as index** - Auto-generated, human-readable discovery
3. **Workspace = folder** - Physical organization, not virtual
4. **Minimal gyoshu/** - Only runtime/ephemeral data lives there
5. **Adapt to existing conventions** - Detect notebooks/, nbs/, analysis/

---

## Directory Structure

### Durable (Tracked in Git)

```
project-root/
├── notebooks/                          # Detected or default location
│   ├── README.md                       # Auto-generated: all workspaces index
│   │
│   ├── _quick/                         # Default workspace for one-off analyses
│   │   ├── README.md                   # Auto-generated: workspace index
│   │   └── 2026-01-01-wine-eda.ipynb
│   │
│   ├── customer-analytics/             # Workspace = folder
│   │   ├── README.md                   # Auto-generated: workspace index
│   │   ├── churn-prediction.ipynb      # Self-describing notebook
│   │   └── ltv-modeling.ipynb
│   │
│   └── experiments/
│       ├── README.md
│       └── wine-clustering.ipynb
│
├── outputs/                            # Mirrors notebook structure
│   ├── customer-analytics/
│   │   ├── churn-prediction/
│   │   │   ├── figures/
│   │   │   ├── models/
│   │   │   └── exports/
│   │   └── ltv-modeling/
│   └── experiments/
│       └── wine-clustering/
│
└── .venv/                              # Python environment (detected)
```

### Ephemeral (Gitignored)

```
project-root/
└── gyoshu/
    ├── .gitignore                      # Ignores everything below
    └── runtime/
        └── {sessionId}/
            ├── bridge.sock             # Python REPL socket
            ├── session.lock            # Session lock
            └── bridge_meta.json        # Runtime state only
```

---

## Notebook YAML Frontmatter Schema

**Location**: First cell of notebook (raw cell type)

```yaml
---
# Quarto-compatible fields (optional, for interop)
title: "Customer Churn Prediction"
date: 2026-01-01
author: "Data Scientist"

# Gyoshu-specific fields (namespaced to avoid conflicts)
gyoshu:
  schema_version: 1
  workspace: customer-analytics      # Folder name
  slug: churn-prediction             # Notebook basename (without .ipynb)
  status: active                     # active | completed | archived
  created: "2026-01-01T10:30:00Z"
  updated: "2026-01-01T15:45:00Z"
  tags:
    - ml
    - classification
    - customer
  
  # Environment
  python_env: .venv
  outputs_dir: outputs/customer-analytics/churn-prediction
  
  # Run history (bounded, lightweight - last 10 runs max)
  runs:
    - id: run-001
      started: "2026-01-01T10:30:00Z"
      ended: "2026-01-01T11:10:00Z"
      status: completed
      notes: "Initial EDA + baseline model"
    - id: run-002
      started: "2026-01-01T14:00:00Z"
      status: in_progress
      notes: "Feature engineering"
---
```

---

## Cell Tags for Structure (Papermill-style)

```python
# Cell metadata.tags array:
["gyoshu-objective"]     # Research objective cell
["gyoshu-hypothesis"]    # Hypothesis statement
["gyoshu-config"]        # Configuration/parameters
["gyoshu-data"]          # Data loading
["gyoshu-analysis"]      # Analysis code
["gyoshu-finding"]       # Key finding
["gyoshu-conclusion"]    # Conclusion
["gyoshu-run-start"]     # Start of a run section
```

---

## README.md Schema

### Root Index: `notebooks/README.md`

```markdown
# Research Index

> Auto-generated by Gyoshu. Manual edits outside marked sections will be preserved.

## Workspaces

<!-- GYOSHU:INDEX:BEGIN -->
| Workspace | Research | Status | Last Updated |
|-----------|----------|--------|--------------|
| [customer-analytics](./customer-analytics/) | 3 projects | 2 active | 2026-01-01 |
| [experiments](./experiments/) | 2 projects | 1 active | 2025-12-28 |
| [_quick](./_quick/) | 5 analyses | - | 2026-01-01 |
<!-- GYOSHU:INDEX:END -->

## Recent Activity

<!-- GYOSHU:RECENT:BEGIN -->
- **[churn-prediction](./customer-analytics/churn-prediction.ipynb)** - active - Feature engineering in progress
- **[wine-clustering](./experiments/wine-clustering.ipynb)** - completed - K-means with 3 clusters
<!-- GYOSHU:RECENT:END -->

## All Tags

<!-- GYOSHU:TAGS:BEGIN -->
`ml` `classification` `clustering` `customer` `eda` `xgboost`
<!-- GYOSHU:TAGS:END -->
```

### Workspace Index: `notebooks/{workspace}/README.md`

```markdown
# Customer Analytics

Research related to customer behavior, retention, and lifetime value.

## Research Projects

<!-- GYOSHU:INDEX:BEGIN -->
| Research | Status | Updated | Tags | Description |
|----------|--------|---------|------|-------------|
| [churn-prediction](./churn-prediction.ipynb) | active | 2026-01-01 | ml, classification | Predict customer churn risk |
| [ltv-modeling](./ltv-modeling.ipynb) | completed | 2025-12-28 | regression | Customer lifetime value |
| [segmentation](./segmentation.ipynb) | archived | 2025-12-15 | clustering | Customer segments |
<!-- GYOSHU:INDEX:END -->

## Workspace Tags

<!-- GYOSHU:TAGS:BEGIN -->
`ml` `classification` `regression` `clustering` `customer`
<!-- GYOSHU:TAGS:END -->
```

---

## Project Profile Detection

**Detection Order** (for existing projects):

| Priority | Check | Notebook Dir | Outputs Dir |
|----------|-------|--------------|-------------|
| 1 | `notebooks/` exists | `notebooks/` | `outputs/` |
| 2 | `nbs/` exists | `nbs/` | `outputs/` |
| 3 | `analysis/` exists | `analysis/` | `analysis_outputs/` |
| 4 | `jupyter/` exists | `jupyter/` | `outputs/` |
| 5 | None found | Create `notebooks/` | Create `outputs/` |

**Python Environment Detection** (already implemented):

| Priority | Check | Python Path |
|----------|-------|-------------|
| 1 | `GYOSHU_PYTHON_PATH` env | Direct path |
| 2 | `.venv/` exists | `.venv/bin/python` |
| 3 | `venv/` exists | `venv/bin/python` |
| 4 | `uv.lock` exists | `uv run python` |
| 5 | `poetry.lock` exists | `poetry run python` |
| 6 | `environment.yml` exists | `conda run python` |
| 7 | None found | Create with best available tool |

---

## Implementation Todo List

### Phase 1: Core Infrastructure (Foundation)

- [x] 1. Add project profile detection to `paths.ts`
   - Detect existing notebook directories (notebooks/, nbs/, analysis/)
   - Detect existing output directories
   - Cache detected profile
   - Add `getNotebookRootDir()`, `getOutputsRootDir()` helpers
   - **Parallelizable**: NO (foundation)

- [x] 2. Create `notebook-frontmatter.ts` library
   - Parse YAML frontmatter from first raw cell
   - Update frontmatter preserving rest of notebook
   - Validate against schema version
   - Handle Quarto compatibility
   - **Parallelizable**: NO (foundation)

- [x] 3. Create `readme-index.ts` library
   - Parse README.md with sentinel blocks
   - Update only content between `<!-- GYOSHU:*:BEGIN -->` and `<!-- GYOSHU:*:END -->`
   - Preserve user content outside sentinels
   - Atomic writes
   - **Parallelizable**: YES (after Task 2)

### Phase 2: Notebook Writer Refactor

- [x] 4. Update `notebook-writer.ts` for new structure
   - Create notebooks in detected notebook root (not gyoshu/research/)
   - Ensure first cell has YAML frontmatter on create
   - Path: `{notebookRoot}/{workspace}/{slug}.ipynb`
   - **Parallelizable**: NO (depends on Tasks 1-2)

- [x] 5. Add cell tagging support to `notebook-writer.ts`
   - Tag cells with gyoshu-* markers on append
   - Support run section markers
   - **Parallelizable**: YES (with Task 4)

- [x] 6. Update `python-repl.ts` auto-capture for new paths
   - Use detected notebook location via getNotebookRootDir()
   - Update frontmatter on each run when runId is provided
   - Support workspace/slug parameters for path computation
   - **Parallelizable**: YES (after Task 4)

### Phase 3: Research Manager Refactor

- [x] 7. Refactor `research-manager.ts` to scan notebooks
   - `list` action: Scan notebook dirs, parse frontmatter
   - Remove dependency on research.json for new research
   - Keep legacy fallback for migration period
   - **Parallelizable**: NO (major refactor)

- [x] 8. Update `research-manager.ts` create/update actions
   - Create notebook with frontmatter (not research.json)
   - Update frontmatter on changes
   - Auto-generate workspace README.md
   - **Parallelizable**: YES (after Task 7)

- [x] 9. Update `notebook-search.ts` for new structure
   - Search in detected notebook locations
   - Parse frontmatter for filtering (workspace, tags, status)
   - Support workspace scoping
   - **Parallelizable**: YES (after Task 7)

### Phase 4: Workspace Management

- [x] 10. Create workspace management in `research-manager.ts`
   - `workspace-list`: List all workspace folders
   - `workspace-create`: Create folder + README.md
   - `workspace-sync`: Regenerate README.md from notebooks
   - **Parallelizable**: NO (new feature)

- [x] 11. Add `/gyoshu workspace` subcommands
   - `list`: Show all workspaces
   - `create <name>`: Create new workspace
   - `sync [name]`: Regenerate README indexes
   - **Parallelizable**: YES (after Task 10)

### Phase 5: Session Simplification

- [x] 12. Simplify `session-manager.ts` to runtime-only
   - Remove durable metadata storage
   - Keep only: lock files, bridge sockets, bridge_meta.json
   - Move session state to notebook frontmatter
   - **Parallelizable**: NO (careful refactor)
   - **Completed**: 2026-01-01 - Replaced SessionManifest with lightweight BridgeMeta

- [x] 13. Update `gyoshu/` directory to minimal structure
   - Only `runtime/` subdirectory
   - Auto-generate `.gitignore` that ignores everything
   - Remove legacy directories on init (with backup)
   - **Parallelizable**: YES (after Task 12)
   - **Completed**: 2026-01-01 - ensureGyoshuRuntimeSync creates minimal structure with .gitignore

### Phase 6: Agent Updates

- [x] 14. Update `jogyo.md` agent for new workflow
   - Read/write frontmatter instead of research.json
   - Use workspace-aware paths
   - Tag cells with gyoshu-* markers
   - **Parallelizable**: NO (depends on Phase 3)
   - **Completed**: 2026-01-01 - Added Notebook-Centric Workflow section with auto-capture and cell tagging

- [x] 15. Update `gyoshu.md` planner for new structure
   - Workspace-aware discovery
   - New workspace subcommands
   - Update status display for workspace view
   - **Parallelizable**: YES (with Task 14)
   - **Completed**: 2026-01-01 - Added workspace management, updated discovery and research workflows

### Phase 7: Migration & Cleanup

- [x] 16. Create migration tool for existing research
   - Added `migrate-to-notebooks` action to migration-tool.ts
   - Added `scan-research` action to scan gyoshu/research/ projects
   - Migrates notebooks with YAML frontmatter to notebooks/_migrated/
   - Copies artifacts to outputs/_migrated/{slug}/
   - Updated /gyoshu migrate command with --to-notebooks flag
   - **Completed**: 2026-01-01
   - Read `gyoshu/research/*/research.json`
   - Embed metadata into notebook frontmatter
   - Move notebooks to detected notebook location
   - Move artifacts to outputs directory
   - Keep legacy data as backup
   - **Parallelizable**: NO (careful migration)

- [x] 17. Update documentation
   - AGENTS.md: New directory structure
   - README.md: New commands and workflow
   - Added ARCHITECTURE.md explaining the design (actually added to AGENTS.md/README.md)
   - **Parallelizable**: YES (after Tasks 14-16)

### Phase 8: Testing

- [x] 18. Add tests for new components
   - `notebook-frontmatter.ts` parsing/updating
   - `readme-index.ts` sentinel preservation
   - Project profile detection
   - **Parallelizable**: YES (after each component)
   - **Completed**: 2026-01-01 - Tests in .opencode/lib/*.test.ts and .opencode/tool/*.test.ts

- [x] 19. Integration tests for full workflow
   - Create research → notebook created with frontmatter
   - Continue research → frontmatter updated
   - List research → scans notebooks correctly
   - Search → finds by tags, workspace, status
   - **Parallelizable**: YES (after Tasks 18)
   - **Completed**: 2026-01-01 - Integration tests in research-manager.test.ts and notebook-search.test.ts

- [x] 20. Run full test suite and fix issues
   - `bun test` - all tests pass
   - Manual testing of `/gyoshu` commands
   - **Parallelizable**: NO (final validation)
   - **Completed**: 2026-01-01 - 479 tests pass (163 in tests/ + 316 in .opencode/)

---

## Migration Strategy

### Phase A: Dual-Read (Safe, Reversible)

New code reads in this order:
1. Try notebook frontmatter first
2. Fall back to legacy `gyoshu/research/*/research.json`

### Phase B: Embed Metadata

For each legacy research:
1. Find notebook in `gyoshu/research/{id}/notebooks/`
2. Add YAML frontmatter with existing metadata
3. Generate workspace README.md

### Phase C: Relocate (Optional)

Move notebooks/artifacts to new locations:
- `gyoshu/research/{id}/notebooks/*.ipynb` → `notebooks/{workspace}/{slug}.ipynb`
- `gyoshu/research/{id}/artifacts/` → `outputs/{workspace}/{slug}/`
- Keep legacy paths as symlinks or references

### Phase D: Cleanup (After Confidence)

After stable release:
- Remove legacy `research.json` creation
- Archive old `gyoshu/research/` structure
- Update documentation

---

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Frontmatter location | First raw cell | Quarto-compatible, visible in Jupyter |
| Namespace | `gyoshu:` block | Avoids conflicts with Quarto/nbdev |
| Run history | In frontmatter (bounded) | Self-contained, no separate files |
| README updates | Sentinel blocks | Preserve user edits |
| Workspace identity | Folder name | Simple, physical, visible |
| Default workspace | `_quick/` | Underscore sorts first, indicates temporary |

---

## Files to Create

1. `.opencode/lib/notebook-frontmatter.ts` - Frontmatter parsing/updating
2. `.opencode/lib/readme-index.ts` - README generation with sentinels
3. `.opencode/lib/project-profile.ts` - Profile detection (or add to paths.ts)

## Files to Modify

1. `.opencode/lib/paths.ts` - Add profile detection, new getters
2. `.opencode/tool/notebook-writer.ts` - New paths, frontmatter
3. `.opencode/tool/research-manager.ts` - Scan-based listing
4. `.opencode/tool/notebook-search.ts` - New search locations
5. `.opencode/tool/session-manager.ts` - Simplify to runtime-only
6. `.opencode/tool/python-repl.ts` - Update for new paths
7. `.opencode/command/gyoshu.md` - Workspace subcommands
8. `.opencode/agent/jogyo.md` - New workflow
9. `.opencode/agent/gyoshu.md` - Workspace awareness
10. `AGENTS.md` - New structure docs
11. `README.md` - Updated commands

---

## Acceptance Criteria

1. [ ] New research creates notebook in `notebooks/{workspace}/` with frontmatter
2. [ ] `research-manager list` works by scanning notebooks (no research.json)
3. [ ] `research-manager search` filters by frontmatter fields
4. [ ] README.md auto-generated with correct indexes
5. [ ] `gyoshu/` contains only `runtime/` (ephemeral)
6. [ ] Legacy research still accessible during migration
7. [ ] All 163+ tests pass
8. [ ] `/gyoshu workspace list/create/sync` commands work

---

## Estimated Effort

| Phase | Tasks | Effort |
|-------|-------|--------|
| Phase 1: Infrastructure | 1-3 | 3-4h |
| Phase 2: Notebook Writer | 4-6 | 2-3h |
| Phase 3: Research Manager | 7-9 | 4-5h |
| Phase 4: Workspace | 10-11 | 2h |
| Phase 5: Session | 12-13 | 2h |
| Phase 6: Agents | 14-15 | 2h |
| Phase 7: Migration | 16-17 | 3h |
| Phase 8: Testing | 18-20 | 3h |

**Total**: ~22-25 hours (3-4 days)
